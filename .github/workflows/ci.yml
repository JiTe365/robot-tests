# .github/workflows/robot-ci.yml
name: Robot CI
on: [push, pull_request]

jobs:
  api-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install pipenv
        run: |
          python -m pip install --upgrade pip
          python -m pip install pipenv==2024.0.1

      - name: Install project deps
        env:
          PIPENV_VENV_IN_PROJECT: "1"
          PIPENV_IGNORE_VIRTUALENVS: "1"
        run: |
          pipenv sync || pipenv install

      - name: Run API Robot tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          pipenv run robot \
            -P "$GITHUB_WORKSPACE" \
            --listener listeners.auto_artifacts.AutoArtifacts:results/api_failures \
            -d results/api tests/api

      - name: Upload API results
        uses: actions/upload-artifact@v4
        with:
          name: robot-api-results
          path: results/api

  ui-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install pipenv
        run: |
          python -m pip install --upgrade pip
          python -m pip install pipenv==2024.0.1

      - name: Install project deps
        env:
          PIPENV_VENV_IN_PROJECT: "1"
          PIPENV_IGNORE_VIRTUALENVS: "1"
        run: |
          pipenv sync || pipenv install

      - name: Install Playwright browsers for Robot Browser lib
        run: |
          pipenv run python -m Browser.entry init

      - name: Run UI Robot tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          xvfb-run -a pipenv run robot             --listener listeners/auto_artifacts.py:AutoArtifacts:results/failures             -d results/ui-main tests/ui
          xvfb-run -a pipenv run robot             --listener listeners/auto_artifacts.py:AutoArtifacts:results/failures             -d results/ui-trace tests/trace
      - name: Upload UI results (main)
        uses: actions/upload-artifact@v4
        with:
          name: robot-ui-results
          path: results/ui
